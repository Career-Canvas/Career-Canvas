# Supabase Database Integration Guide

## Database Schema
Your Supabase database has the following table structure for course reviews:

```sql
create table public.course_reviews (
  id uuid not null default gen_random_uuid (),
  created_at timestamp with time zone not null default now(),
  university_name text not null,
  course_name text not null,
  review_text text not null,
  author text null,
  email text null,
  rating integer null,
  is_approved boolean null default false,
  constraint course_reviews_pkey primary key (id)
) TABLESPACE pg_default;
```

## Data Mapping

When a user submits a course review, the form data is mapped to your database schema as follows:

### Form Data ‚Üí Database Fields

| Form Field | Database Field | Type | Required | Notes |
|------------|----------------|------|----------|-------|
| `university` | `university_name` | text | ‚úÖ | University short name (Wits, UJ, UCT) |
| `course` | `course_name` | text | ‚úÖ | Full course name |
| `reviewText` | `review_text` | text | ‚úÖ | User's review content |
| `author` | `author` | text | ‚ùå | Optional user name |
| `email` | `email` | text | ‚ùå | Optional user email |
| `rating` | `rating` | integer | ‚ùå | Optional 1-5 star rating |
| - | `is_approved` | boolean | ‚ùå | Defaults to false |
| - | `created_at` | timestamp | ‚ùå | Auto-generated by database |
| - | `id` | uuid | ‚ùå | Auto-generated by database |

## Example Data Flow

### 1. User Submits Form
```typescript
const formData = {
  author: "John Doe",
  email: "john@example.com",
  university: "Wits",
  course: "BSc Computer Science",
  reviewText: "Great program with excellent professors!",
  rating: 5
};
```

### 2. Data Prepared for Database
```typescript
const reviewData = {
  university_name: "Wits",
  course_name: "BSc Computer Science",
  review_text: "Great program with excellent professors!",
  author: "John Doe",
  email: "john@example.com",
  rating: 5,
  is_approved: true
};
```

### 3. Saved to Supabase
```sql
INSERT INTO course_reviews (
  university_name, 
  course_name, 
  review_text, 
  author, 
  email, 
  rating, 
  is_approved
) VALUES (
  'Wits',
  'BSc Computer Science',
  'Great program with excellent professors!',
  'John Doe',
  'john@example.com',
  5,
  true
);
```

### 4. Database Record
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "created_at": "2024-01-20T10:30:00Z",
  "university_name": "Wits",
  "course_name": "BSc Computer Science",
  "review_text": "Great program with excellent professors!",
  "author": "John Doe",
  "email": "john@example.com",
  "rating": 5,
  "is_approved": true
}
```

## Implementation Status

### ‚úÖ Backend API Ready
- **Data Structure**: All form fields map correctly to database schema
- **Type Safety**: TypeScript interfaces match database fields exactly
- **Backend Service**: Express.js API routes handle all Supabase operations
- **Frontend Service**: Updated to call backend API instead of direct Supabase calls
- **Error Handling**: Comprehensive error handling in place

### üîÑ Next Steps
1. **Start Backend Server**:
   ```bash
   cd backend
   npm start
   ```

2. **Test Backend API**:
   ```bash
   cd backend
   node test-course-reviews.js
   ```

3. **Verify Database Connection**:
   - Check backend logs for Supabase connection status
   - Verify course_reviews table exists in your Supabase database
   - Test API endpoints with the test script

## Database Queries

### Insert New Review
```typescript
const { data, error } = await supabase
  .from('course_reviews')
  .insert([reviewData])
  .select()
  .single();
```

### Get Reviews for Specific Course
```typescript
const { data, error } = await supabase
  .from('course_reviews')
  .select('*')
  .eq('university_name', university)
  .eq('course_name', course)
  .eq('is_approved', true)
  .order('created_at', { ascending: false });
```

### Get All Approved Reviews
```typescript
const { data, error } = await supabase
  .from('course_reviews')
  .select('*')
  .eq('is_approved', true)
  .order('created_at', { ascending: false });
```

## Data Validation

### Required Fields
- `university_name`: Must be one of: "Wits", "UJ", "UCT"
- `course_name`: Must exist in your courses data
- `review_text`: Minimum 10 characters, maximum 1000

### Optional Fields
- `author`: Maximum 50 characters
- `email`: Valid email format
- `rating`: Integer 1-5

### Auto-Generated Fields
- `id`: UUID generated by database
- `created_at`: Timestamp when record is created
- `is_approved`: Defaults to false (can be used for moderation)

## Security Considerations

### Row Level Security (RLS)
Consider adding RLS policies to your table:

```sql
-- Enable RLS
ALTER TABLE course_reviews ENABLE ROW LEVEL SECURITY;

-- Allow public read access to approved reviews
CREATE POLICY "Allow public read access to approved reviews" ON course_reviews
  FOR SELECT USING (is_approved = true);

-- Allow authenticated users to insert reviews
CREATE POLICY "Allow authenticated users to insert reviews" ON course_reviews
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');
```

### API Key Protection
- Store Supabase credentials in environment variables
- Never commit `.env` files to version control
- Use appropriate API key permissions

## Testing

### 1. Test Form Submission
- Fill out the course review form
- Check browser console for prepared data
- Verify data structure matches database schema

### 2. Test Database Connection
- Implement basic Supabase connection
- Test insert operation
- Verify data appears in your database

### 3. Test Data Retrieval
- Implement review fetching
- Test with different university/course combinations
- Verify pagination and filtering work correctly

## Troubleshooting

### Common Issues
1. **Field Mismatch**: Ensure form field names match database column names exactly
2. **Type Mismatch**: Check that data types match (string vs text, number vs integer)
3. **Required Fields**: Verify all required fields are provided
4. **Permissions**: Check Supabase RLS policies and API key permissions

### Debug Steps
1. Check browser console for data being prepared
2. Verify Supabase connection is working
3. Check database logs for any constraint violations
4. Test with simple data first, then complex reviews

## Ready to Deploy!

Your course review system is now perfectly aligned with your Supabase database schema and uses a proper backend API architecture. The data will be saved exactly as you've defined it, with proper type safety and validation.

**Current Architecture:**
- **Frontend**: React components with TypeScript interfaces
- **Backend**: Express.js API routes handling Supabase operations
- **Database**: Supabase with your exact `course_reviews` table schema

**To deploy:**
1. Start your backend server
2. Ensure your Supabase database is accessible
3. Test the API endpoints
4. Deploy both frontend and backend

The system will seamlessly save reviews to your `course_reviews` table through the backend API!
